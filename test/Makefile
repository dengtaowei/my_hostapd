# ========== é…ç½®éƒ¨åˆ† ==========
KERNEL_VERSION := $(shell uname -r)
KERNEL_DIR ?= /lib/modules/$(KERNEL_VERSION)/build
MAKE := make
JOBS := 4  # è‡ªåŠ¨æ£€æµ‹CPUæ ¸å¿ƒæ•°

# æ¨¡å—åˆ—è¡¨å’Œä¾èµ–å…³ç³»
MODULES := cfg80211 mac80211 mac80211_hwsim
MODULE_DEPS := cfg80211 mac80211  # mac80211_hwsimä¾èµ–å‰ä¸¤ä¸ª

# è¾“å‡ºæ§åˆ¶
QUIET := @
ifneq ($(V),)
  QUIET :=
endif

.PHONY: all clean install uninstall help $(MODULES)

# ========== ä¸»è¦ç›®æ ‡ ==========
help:
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  all        - ç¼–è¯‘æ‰€æœ‰æ¨¡å—ï¼ˆé»˜è®¤ï¼‰"
	@echo "  clean      - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  install    - å®‰è£…æ‰€æœ‰æ¨¡å—"
	@echo "  uninstall  - å¸è½½æ‰€æœ‰æ¨¡å—"
	@echo "  check      - æ£€æŸ¥ç¼–è¯‘ç¯å¢ƒ"
	@echo ""
	@echo "é€‰é¡¹:"
	@echo "  V=1        - æ˜¾ç¤ºè¯¦ç»†è¾“å‡º"
	@echo "  JOBS=N     - æŒ‡å®šå¹¶è¡Œä»»åŠ¡æ•°"

# é»˜è®¤ç›®æ ‡
all: $(MODULES)
	$(QUIET)echo "âœ… æ‰€æœ‰å†…æ ¸æ¨¡å—ç¼–è¯‘å®Œæˆ"

# æ£€æŸ¥ç¯å¢ƒ
check:
	@echo "æ£€æŸ¥ç¼–è¯‘ç¯å¢ƒ..."
	@test -d $(KERNEL_DIR) || { echo "é”™è¯¯: å†…æ ¸ç›®å½•ä¸å­˜åœ¨: $(KERNEL_DIR)"; exit 1; }
	@echo "âœ“ å†…æ ¸ç›®å½•: $(KERNEL_DIR)"
	@echo "âœ“ å†…æ ¸ç‰ˆæœ¬: $(KERNEL_VERSION)"
	@echo "âœ“ å¹¶è¡Œä»»åŠ¡: $(JOBS)"

# ========== æ¨¡å—ç¼–è¯‘ ==========
# æ–¹æ³•1ï¼šé¡ºåºç¼–è¯‘ï¼ˆç¡®ä¿ä¾èµ–å…³ç³»ï¼‰
cfg80211: check
	$(QUIET)echo "ğŸ“¦ ç¼–è¯‘ cfg80211..."
	$(MAKE) -C cfg80211 KERNEL_DIR=$(KERNEL_DIR) -j$(JOBS)

mac80211: cfg80211
	$(QUIET)echo "ğŸ“¦ ç¼–è¯‘ mac80211..."
	$(MAKE) -C mac80211 KERNEL_DIR=$(KERNEL_DIR) -j$(JOBS)

mac80211_hwsim: mac80211
	$(QUIET)echo "ğŸ“¦ ç¼–è¯‘ mac80211_hwsim..."
	$(MAKE) -C mac80211_hwsim KERNEL_DIR=$(KERNEL_DIR) -j$(JOBS)

# æ–¹æ³•2ï¼šä½¿ç”¨æ¨¡å¼è§„åˆ™ï¼ˆå¦‚æœæ¨¡å—é—´æ— ä¾èµ–ï¼‰
# %:
# 	$(QUIET)echo "ç¼–è¯‘ $@..."
# 	$(MAKE) -C $@ KERNEL_DIR=$(KERNEL_DIR) -j$(JOBS)

# ========== å®‰è£…å’Œå¸è½½ ==========
install: all
	$(QUIET)echo "ğŸ”§ å®‰è£…æ¨¡å—..."
	$(QUIET)sudo $(MAKE) -C cfg80211 install
	$(QUIET)sudo $(MAKE) -C mac80211 install
	$(QUIET)sudo $(MAKE) -C mac80211_hwsim install
	$(QUIET)echo "âœ… æ¨¡å—å®‰è£…å®Œæˆ"

uninstall:
	$(QUIET)echo "ğŸ—‘ï¸  å¸è½½æ¨¡å—..."
	-$(QUIET)sudo rmmod mac80211_hwsim 2>/dev/null || true
	-$(QUIET)sudo rmmod mac80211 2>/dev/null || true
	-$(QUIET)sudo rmmod cfg80211 2>/dev/null || true
	$(QUIET)echo "âœ… æ¨¡å—å¸è½½å®Œæˆ"

# ========== æ¸…ç† ==========
clean:
	$(QUIET)echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	$(QUIET)for dir in $(MODULES); do \
		$(MAKE) -C $$dir clean; \
	done
	$(QUIET)find . -name "*.ko" -delete
	$(QUIET)find . -name "*.o" -delete
	$(QUIET)find . -name "*.mod.c" -delete
	$(QUIET)find . -name "Module.symvers" -delete
	$(QUIET)find . -name "modules.order" -delete
	$(QUIET)echo "âœ… æ¸…ç†å®Œæˆ"

# ========== æµ‹è¯•ç›®æ ‡ ==========
test: all
	$(QUIET)echo "ğŸ§ª æµ‹è¯•æ¨¡å—..."
	$(QUIET)sudo insmod cfg80211/cfg80211.ko
	$(QUIET)sudo insmod mac80211/mac80211.ko
	$(QUIET)sudo insmod mac80211_hwsim/mac80211_hwsim.ko
	$(QUIET)echo "âœ… æ¨¡å—åŠ è½½æµ‹è¯•å®Œæˆ"

load: test  # åˆ«å

# æŸ¥çœ‹æ¨¡å—ä¿¡æ¯
info:
	@for dir in $(MODULES); do \
		if [ -f $$dir/*.ko ]; then \
			echo "=== $$dir ==="; \
			modinfo $$dir/*.ko | head -5; \
		fi; \
	done